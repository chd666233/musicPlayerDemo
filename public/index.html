<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    *{padding:0;margin:0}
    body,#box .before,#btn div .before{
      /* fixed自动对齐图片位置的功能出不来 */
      background:url(img/323799.jpg) no-repeat fixed;
    }
    /* box */
    #box{
      position: relative;
      width:600px;
      height:450px;
      position:relative;
      overflow: hidden;
      margin:50px auto 10px;
      box-shadow:0 0 20px;  
    }
    #box .before,#btn div .before{
      content:'';
      position: absolute;
      /* 1 通过这种方式设置宽高，不能通过width 100% height 100% 因为配合margin:-30px指挥导致不能铺满父元素 */
      top: 0;left: 0;right: 0;bottom: 0;
      /* background-size:cover; 不能设置cover不然fixed自动对齐图片位置的功能出不来*/
      filter:blur(30px);
      margin:-30px;
      overflow:hidden;
    }
    #box .after,#btn div .after{
      content:'';
      position: absolute;
      top: 0;left: 0;right: 0;bottom: 0;
      background:rgba(0,0,0,.5);
      filter:blur(30px);
      margin:-30px;
    }
    /* bg */
    #bg{
      position: absolute;
      top:0;left:0;
      width:100%;
      position: absolute;
      z-index:1000;
      text-align:center;
    }
    .bg{
      transition:top 1s;
    }
    p{
      color:#989898;
      /* height:21px; */
      margin:16px 0;
    }
    .text-white{
      color:#fff;
      transition:color .7s,transform .7s;
      transform: scale(1.1);
    }
    /* bar */
    #bar{
      width:10px;height:100px;
      position: absolute;
      right:0;top:0;
      border-radius: 5px;
      background:rgba(0,0,0,.3);
      transition:background .5s;
    }
    .bar{
      transition:background .5s,top .5s!important;
    }
    #box:hover #bar{
      background:rgba(0,0,0,.75);
    }
    /* 播放按钮等 */
    #btn{
      width:600px;
      margin:0 auto;
    }
    #btn div{
      width:146px;height:50px;
      display:inline-block;
      position:relative;
      background:rgba(0,0,0,.5);
      border:none;
      border-radius:5px;
      outline:none;
      font-weight:bold;
      text-align:center;
      overflow:hidden;
    }
    #btn button{
      position: absolute;
      left:0;right:0;
      width:100%;height:100%;
      background:transparent;
      border:none;
      outline: 0;
      line-height:50px;
      color:#989898;
      font-size:20px;
      z-index:1000;
    }
    #btn button:active{
      color:turquoise;
    }
   /* progress-bar */
   #progressBar{
     width:600px;
     height:10px;
     margin: 0 auto 10px;
     position:relative;
     background:rgba(0, 0, 0, 0.7);
     border-radius: 5px;
     transition:background .5s;
   }
   #progressBar:hover{
    background:rgba(0,0,0,.75);
   }
   #circle{
     position:absolute;
     left:0;top:-5px;
     width:18px;height:18px;
     border-radius:50%;
     background:red;
   }
  </style>
</head>
<body>
  <div id="box" >
    <div class="before"></div>
    <div id="bg" class="bg"></div>
    <div id="bar" class="bar"></div>
    <div class="after"></div>
  </div>
  <div id="progressBar">
    <div id="circle"></div>
  </div>
  <div>
    <audio src="music/李学仕 - 直觉.mp3" controls id="audio" style="display:none"></audio>
		<div id="btn" class="btn">
			<div>
        <div class="before"></div>
        <button id="play">Play</button>
        <div class="after"></div>
      </div>
			<div>
        <div class="before"></div>
        <button id="pause">Pause</button>
        <div class="after"></div>
      </div>
			<div>
        <div class="before"></div>
        <button id="prev">Prev</button>
        <div class="after"></div>
      </div>
			<div>
        <div class="before"></div>
        <button id="next">Next</button>
        <div class="after"></div>
      </div>
  </div>
  <script>
    "use strict";
    // 添加/移出标签的class
    var CSSClass={};
    CSSClass.is=function(e,c){
      if(typeof e =='string') e=document.getElementById(e);
      var classes=e.className;
      if(!classes) return false;
      if(classes==c) return true;
      // 不能用  !!classes.search('\\b'+c+'\\b')，因为有可能返回0,表示位置0
      return classes.search('\\b'+c+'\\b')!=-1; 
    }
    CSSClass.add=function(e,c){
      if(typeof e=='string') e=document.getElementById(e);
      if(this.is(e,c)) return;
      if(e.className) c=' '+c;
      e.className+=c;
    }
    CSSClass.remove=function(e,c){
      if(typeof e=='string') e=document.getElementById(e);
      if(!this.is(e,c)) return;//没有这个class返回
      var reg=new RegExp('\\b'+c+'\\b');
      //e.className=e.className.replace('\\b'+c+'\\b','');这样replace就不能匹配到，很奇怪
      e.className=e.className.replace(reg,'');
    }
    var vars=(function(){
      return {
        gc:'',
        times:[],
        speed:300,
        interval:null,
        gc_scroll:null,
        ps:[],
        can_scroll:true,
        progressInterval:null,
        duration:0,
        progressBarW:0,
        progressBarSingleMv:0,
        circleW:0,
        len:0,
        progressBarMv:0
      };
    })();
    
    function getH(){

      //获得页面中的歌词的所有P标签
      var nodeList=bg.childNodes;
      vars.ps=[];
      for(var i=0;i<nodeList.length;i++){
        if(nodeList[i].nodeType==1) vars.ps.push(nodeList[i]);
      }
      console.log('--->',nodeList.length,vars.ps.length,vars.times.length)


      // for(var i=0;i<nodeList.length;i++){
      //   console.log(nodeList[i].innerHTML)
      // }
      
    
      if(vars.ps.currentStyle){//ie
        vars.pMT=parseFloat(vars.ps[0].currentStyle.marginTop);
        vars.boxH=parseFloat(box.currentStyle.height);
      }else if(window.getComputedStyle){
        vars.pMT=parseFloat(window.getComputedStyle(vars.ps[0],null).marginTop);
        vars.bgH=parseFloat(window.getComputedStyle(bg,null).height);
        vars.boxH=parseFloat(window.getComputedStyle(box,null).height);
      }

       //计算滚动条的长度,设置滚动条高度，用滚动条的高度体现文档的长度
      // bar.style.cssText=`height:${boxH/bgH*boxH}px`;
      // bar.setAttribute('style',`height:${boxH/bgH*boxH}px`);
      vars.barH=vars.boxH/vars.bgH*vars.boxH;
      vars.scrollDis=0,vars.mv=0;
    }
    //因为条歌词的p标签不一定是1行，可能是多行，它们之间的行数不一定相等，所以需要动态获取。
    function distance(i){
      if(vars.ps.currentStyle){//ie
        vars.pH=parseFloat(vars.ps[i].currentStyle.height);
      }else if(window.getComputedStyle){
        vars.pH=parseFloat(window.getComputedStyle(vars.ps[i],null).height);
      }
      vars.dis=vars.pH+vars.pMT;
      vars.singleDis=vars.dis/vars.bgH*vars.boxH;
      // console.log(vars.pH);
    }

    
    //请求歌词
    function get_gc(box,action,callback){
        //请求歌词，将歌词插入页面
      var xhr=new XMLHttpRequest();
      xhr.onreadystatechange=function(){
        if(xhr.readyState==4&&xhr.status==200){
          vars.gc=xhr.responseText;
          // console.log(vars.gc)
          //获取的歌词进行全局查找，查找全部内容，将查找结果放到数组里面
          //\u0800-\u4e00 日文  \uac00-\ud7ff (韩文)
          // console.log(vars.gc)
          var arr=vars.gc.match(/\[\d{2}:\d{2}(\.\d{2}\d?)?\][\u4e00-\u9fa5a-zA-Z\u0800-\u4e00\uac00-\ud7ff]*.*[\u4e00-\u9fa5a-zA-Z\u0800-\u4e00\uac00-\ud7ff]*\s*/g);
          // console.log(arr)
          var _times=vars.gc.match(/\d{2}:\d{2}(\.\d{2}\d?)?/g);
          // console.log(arr.length,arr)
          //截取出歌词和时间
          vars.gc='';
          var i=0,_i=0;
          vars.times.splice(0);
          while(i<arr.length){
            // console.log(i)
            arr[i]=arr[i].replace(/\[\d{2}:\d{2}(\.\d{2}\d?)?\]|\s*$/g,'');
            var temp=_times[i].split(/[\.:]/g);
            temp=parseInt(temp[0])*60*1000+parseInt(temp[1])*1000+parseInt(temp[2]||0);
            vars.times.push(temp);
            vars.gc+=`<p dateTime="${vars.times[_i]}">${arr[i]}`;
            
            //把时间转换成毫秒
            for(;i<arr.length-1;i++){
              var _temp=_times[i+1].split(/[\.:]/g);
              _temp=parseInt(_temp[0])*60*1000+parseInt(_temp[1])*1000+parseInt(_temp[2]||0);
              // console.log(i,i+1,temp,_temp)
              if(temp==_temp){
                arr[i+1]=arr[i+1].replace(/\[\d{2}:\d{2}(\.\d{2}\d?)?\]|\s*$/g,'');
                vars.gc+=`<br>${arr[i+1]}`;
                // i++;
                // console.log('-------------')
              }else{
                _i++;
                break;//不相同，break
              }    
            }
            vars.gc+=`</p>`
            i++;
          }
          // console.log(arr)
          //插入P标签
          bg.innerHTML=vars.gc;
          getH();
           //初始化bg bar的top
          bg.style.cssText=`top:${0}px;`;
          bar.style.cssText=`height:${vars.barH}px;top:${0}px`;
          callback&&callback(vars.speed);
        }
      }
      action=action||'prev';
      xhr.open('get',`/${action}`,true);
      xhr.send(null);
    }
    get_gc(bg);
    
   //滚动
    function fn(speed){
      speed=speed||800;
      
      CSSClass.add(vars.ps[0],'text-white');
      //歌词滚动闭包
     
      vars.gc_scroll=(function(){
        var index=0,time=0;
        return function(){
          time+=speed;
          //歌词滚动
          if(time>vars.times[index]){
            //根据每个p的高度动态获取滚动距离
            distance(index);
            //走掉的高度大于box高度的一半
            if(vars.dis*(index)>=vars.boxH/2){
              //剩下的没滚动的总高度大于box高度的一半
              if(vars.dis*(vars.ps.length-index)>=vars.boxH/2){
                vars.mv-=vars.dis;
                //滚动距离
                vars.scrollDis+=vars.singleDis;
                if(vars.can_scroll){
                    //歌词滚动
                  bg.style.cssText=`top:${vars.mv}px;`;
                  //滚动条滚动
                  bar.style.cssText=`height:${vars.barH}px;top:${vars.scrollDis}px`
                }
              }
            }
            //给每个歌词的P标签样式
            CSSClass.add(vars.ps[index],'text-white');
            if(index>0){
              CSSClass.remove(vars.ps[index-1],'text-white');
            }
            //index等于p标签长度了表示滚动结束
            // console.log(index)
            if(index==vars.times.length-1) clearInterval(vars.interval);
            index++;
          }
        }
      })()
      if(vars.interval) clearInterval(vars.interval);
      vars.interval=setInterval(vars.gc_scroll,speed);

    }
    var stopWheel=null;
    box.addEventListener('mousewheel',function(e){
      // console.log(bg.getAttribute('style'))
      // console.log(bg.style.top);
      // console.log(window.getComputedStyle(bg,null).top)
      // console.log(e.wheelDelta)
      distance(1);
      vars.can_scroll=false;
      //清除过渡css
      CSSClass.remove(bg,'bg');
      CSSClass.remove(bar,'bar');
      var t=isNaN(parseFloat(bg.style.top))?0:parseFloat(bg.style.top),
      scrollDis2=isNaN(parseFloat(bar.style.top))?0:parseFloat(bar.style.top);
      if(e.wheelDelta>0){//向上滚动，bg向下，top增加,滚动条上滚
        t=t+vars.dis;
        scrollDis2-=vars.singleDis;
        if(t>=0) t=0,scrollDis2=0;
      }else{
        t=t-vars.pH-vars.pMT;
        scrollDis2+=vars.singleDis;
        if(t<=vars.boxH-vars.bgH) t=vars.boxH-vars.bgH,scrollDis2=vars.boxH-vars.barH;
      }
      bg.style.cssText=`top:${t}px`;
      bar.style.cssText=`height:${vars.barH}px;top:${scrollDis2}px`

      //停止滚动，歌词，滚动条滚到歌词当前的位置
      if(stopWheel){
        clearTimeout(stopWheel);
      }
      stopWheel=setTimeout(function(){
        stopWheel=null;
        CSSClass.add(bg,'bg');
        CSSClass.add(bar,'bar');
        //鼠标滚动的时候歌词不要滚动，鼠标停止滚动后歌词可以滚动
        vars.can_scroll=true;
        bg.style.cssText=`top:${vars.mv}px;`;
        bar.style.cssText=`height:${vars.barH}px;top:${vars.scrollDis}px`
      },1000);
    })
    var firstPlay=true;
    btn.addEventListener('click',function(e){
      if(e.target.id=='play'){
        if(audio.paused){
          audio.play();
          //播发器进度条
          if(vars.progressInterval) clearInterval(vars.progressInterval);
          vars.progressInterval=setInterval(()=>{
            vars.progressBarMv+=vars.progressBarSingleMv;
            if(vars.progressBarMv<=vars.len)
              circle.style.cssText=`left:${vars.progressBarMv}px`;
            else clearInterval(vars.progressInterval);
          },1000)
          
          //判断是否刚进入页面还没有点击播放过
          if(firstPlay)  {
            fn(vars.speed);
            firstPlay=false;
          }else{
            clearInterval(vars.interval);
            vars.interval=setInterval(vars.gc_scroll,vars.speed);
          }
        }
      }
      if(e.target.id=='pause'){
        if(!audio.paused){//不能用played判断是否在播放，应该用audio.paused的t/f判断
          
          firstPlay=false;
          audio.pause();
          clearInterval(vars.interval);
          clearInterval(vars.progressInterval);
        }
      }
      if(e.target.id=='next'){
        next();
      }
      if(e.target.id=='prev'){
        prev();
      }
    },false)
    function change(src,action,url){
      firstPlay=true;
      audio.src=src;
      document.body.style=`background:url(${url}) no-repeat fixed`;
      // window.getComputedStyle(box,'::before')//没法设置伪元素
      var arr=document.querySelectorAll('.before');
      for(var a of arr){
        a.style=`background:url(${url}) no-repeat fixed`;
      }
      get_gc(box,action,fn);
      audio.play();
    }
    function next(){
       //进度条重置
       vars.progressBarMv=0;
        circle.style.cssText=`left:${vars.progressBarMv}px`;
        //YUI - Rolling star.mp3 你的叽叽 - 东西（Cover：林俊呈）.mp3  泰仁 - 그 남자의 거짓말.mp3
        change('music/YUI - Rolling star.mp3','next','img/311001.jpg');
        
        if(vars.progressInterval) clearInterval(vars.progressInterval);
          vars.progressInterval=setInterval(()=>{
            vars.progressBarMv+=vars.progressBarSingleMv;
            if(vars.progressBarMv<=vars.len)
              circle.style.cssText=`left:${vars.progressBarMv}px`;
            else clearInterval(vars.progressInterval);
          },1000)
    }
    function prev(){
       //进度条重置
       vars.progressBarMv=0;
        circle.style.cssText=`left:${vars.progressBarMv}px`;
        change('music/李学仕 - 直觉.mp3','prev','img/323799.jpg');
        
        if(vars.progressInterval) clearInterval(vars.progressInterval);
          vars.progressInterval=setInterval(()=>{
            vars.progressBarMv+=vars.progressBarSingleMv;
            if(vars.progressBarMv<=vars.len)
              circle.style.cssText=`left:${vars.progressBarMv}px`;
            else clearInterval(vars.progressInterval);
          },1000)
    }
    //获取音乐长度，计算进度条每次位移距离
    (()=>{
      audio.addEventListener('canplay',()=>{
        // console.log('----------|>',audio.duration);
        vars.duration=audio.duration;
        vars.progressBarW=parseFloat(window.getComputedStyle(progressBar,null).width);
        vars.circleW=parseFloat(window.getComputedStyle(circle,null).width);
        vars.len=vars.progressBarW-vars.circleW;
        vars.progressBarSingleMv=vars.len/vars.duration;
      });
      audio.addEventListener('ended',()=>{
        next();
      });
    })();
    
  
    circle.addEventListener('mousedown',()=>{
      circle.addEventListener('mousemove',fnn);
    });
    document.addEventListener('mouseup',()=>{
      circle.removeEventListener('mousemove',fnn);
    });
    function fnn(e){
      console.log(circle.offsetLeft)
      
      // console.log(e.layerX,e.layerY)
    }
 
    
    
  </script>
</body>
</html>